<main class="reserva-page">
  <div class="reserva-container" [attr.aria-busy]="creating ? 'true' : 'false'">
    <a class="back-link" routerLink="/habitacion-detalle" aria-label="Volver a los detalles">
      <i-bs name="arrow-left" width="18" height="18" class="icon"></i-bs>
      Volver a los detalles
    </a>

    <header class="header">
      <h1 class="title">
        <span class="badge-step">Paso 2/2</span>
        Completar Reserva
      </h1>
      <div class="badges">
        <span class="badge-secure">
          <i-bs name="shield-lock" width="16" height="16" class="icon"></i-bs>
          Pago seguro SSL
        </span>
        <span class="badge-24">
          <i-bs name="headset" width="16" height="16" class="icon"></i-bs>
          Soporte 24/7
        </span>
      </div>
    </header>

    <div class="reserva-main">

      <section class="pago-section">
        <h3 class="section-title">
          <i-bs name="credit-card" width="20" height="20" class="icon accent"></i-bs>
          Información de Pago
        </h3>
        <p class="muted pago-desc">Ingresa los datos de tu tarjeta de crédito o débito</p>

        <div class="brands-row" aria-live="polite">
          <span class="brand visa">VISA</span>
          <span class="brand mc">Mastercard</span>
          <span class="brand amex">Amex</span>
          <span class="brand dsc">Discover</span>
          <span class="detected" *ngIf="cardBrand !== 'unknown'">
            <i-bs name="shield-check" width="16" height="16" class="icon"></i-bs>
            {{ cardBrand | titlecase }}
          </span>
        </div>

        <form class="form-grid" novalidate>
          <label class="field">
            <span class="label">Número de tarjeta</span>
            <div class="input-affix" [class.invalid]="!isCardNumberValid() && touched.tarjeta">
              <i-bs name="credit-card-2-front" width="18" height="18" class="affix"></i-bs>
              <div class="input-inner-wrapper">
                <input
                  type="text"
                  inputmode="numeric"
                  autocomplete="cc-number"
                  maxlength="19"
                  placeholder="1234 5678 9012 3456"
                  [(ngModel)]="tarjeta"
                  name="tarjeta"
                  required
                  (focus)="touched.tarjeta = true"
                  (input)="onTarjetaInput($event)"
                  [attr.aria-invalid]="!isCardNumberValid() && touched.tarjeta ? 'true' : 'false'"
                />
                <button class="clear-btn" type="button" *ngIf="tarjeta" (click)="clearCard()" aria-label="Limpiar">
                  <i-bs name="x" width="18" height="18" class="icon"></i-bs>
                </button>
              </div>
            </div>
            <small class="help" *ngIf="touched.tarjeta && !isCardNumberValid()">
              Verifica el número de la tarjeta.
            </small>
          </label>

          <label class="field">
            <span class="label">Nombre del titular</span>
            <div class="input-affix" [class.invalid]="!isNameValid() && touched.nombre">
              <i-bs name="person-badge" width="18" height="18" class="affix"></i-bs>
              <div class="input-inner-wrapper">
                <input
                  type="text"
                  autocomplete="cc-name"
                  placeholder="Nombre como aparece en la tarjeta"
                  [(ngModel)]="nombre"
                  name="nombre"
                  required
                  (focus)="touched.nombre = true"
                />
              </div>
            </div>
            <small class="help" *ngIf="touched.nombre && !isNameValid()">
              Ingresa el nombre del titular.
            </small>
          </label>

          <div class="row">
            <label class="field">
              <span class="label">Fecha de expiración</span>
              <div class="input-affix" [class.invalid]="!isExpiryValid() && touched.expiracion">
                <i-bs name="calendar3" width="18" height="18" class="affix"></i-bs>
                <div class="input-inner-wrapper">
                  <input
                    type="text"
                    inputmode="numeric"
                    autocomplete="cc-exp"
                    maxlength="5"
                    placeholder="MM/AA"
                    [(ngModel)]="expiracion"
                    name="expiracion"
                    required
                    (focus)="touched.expiracion = true"
                    (input)="onExpiracionInput($event)"
                  />
                </div>
              </div>
              <small class="help" *ngIf="touched.expiracion && !isExpiryValid()">
                Usa el formato MM/AA y una fecha futura.
              </small>
            </label>

            <label class="field">
              <span class="label">CVV</span>
              <div class="input-affix" [class.invalid]="!isCvvValid() && touched.cvv">
                <i-bs name="shield-lock" width="18" height="18" class="affix"></i-bs>
                <div class="input-inner-wrapper">
                  <input
                    [type]="showCvv ? 'text' : 'password'"
                    inputmode="numeric"
                    [maxlength]="cvvMaxLength"
                    placeholder="123"
                    [(ngModel)]="cvv"
                    name="cvv"
                    required
                    (focus)="touched.cvv = true"
                  />
                  <button class="clear-btn" type="button" (click)="showCvv = !showCvv">
                    <i-bs [name]="showCvv ? 'eye-slash' : 'eye'" width="18" height="18" class="icon"></i-bs>
                  </button>
                </div>
              </div>
              <small class="help" *ngIf="touched.cvv && !isCvvValid()">
                Ingresa los {{ cvvMaxLength }} dígitos.
              </small>
              <small class="help" *ngIf="!cvv && !touched.cvv">
                Código de seguridad ({{ cvvMaxLength }} dígitos)
              </small>
            </label>
          </div>

          <div class="pago-seguro">
            <i-bs name="shield-lock" width="20" height="20" class="icon"></i-bs>
            <span>
              <b>Pago 100% seguro</b><br />
              Tus datos están protegidos con encriptación SSL
            </span>
          </div>

          <button
            class="btn btn-primary btn--pago"
            type="button"
            (click)="confirmarPago()"
            [disabled]="creating || pagoInvalido()"
            [attr.aria-busy]="creating ? 'true' : 'false'"
          >
            <span class="btn-text">
              <i-bs name="lock-fill" width="18" height="18" class="icon"></i-bs>
              Confirmar Pago - {{ total }} BOB
            </span>
          </button>

          <p class="terms">
            Al confirmar aceptas nuestras
            <a href="#" (click)="$event.preventDefault()">Condiciones</a> y
            <a href="#" (click)="$event.preventDefault()">Privacidad</a>.
          </p>
        </form>
      </section>

      <aside class="card resumen-card">
        <h4 class="card-title">
          <i-bs name="receipt" width="18" height="18" class="icon accent"></i-bs>
          Resumen de reserva
        </h4>

        <div class="hotel-info">
          <div class="hotel-name">
            <i-bs name="building" width="16" height="16" class="icon"></i-bs>
            <b>{{ hotel.nombre || 'Hotel' }}</b>
          </div>
          <div class="hotel-city" *ngIf="hotel.ciudad">
            <i-bs name="geo-alt" width="16" height="16" class="icon"></i-bs>
            {{ hotel.ciudad }}
          </div>
        </div>

        <div class="resumen-datos">
          <div class="line">
            <i-bs name="people" width="16" height="16" class="icon"></i-bs>
            Huéspedes
            <span class="right">{{ huespedes }}</span>
          </div>
          <div class="line">
            <i-bs name="moon-stars" width="16" height="16" class="icon"></i-bs>
            Noches
            <span class="right">{{ noches }}</span>
          </div>

          <!-- Fechas editables SOLO para reservas normales (no paquete) -->
          <div class="fechas-grid" *ngIf="!esPaquete">
            <label class="fecha-item">
              <span class="lbl">Check-in</span>
              <input
                type="date"
                [min]="minFechaReserva"
                [(ngModel)]="fecha_reserva"
                name="fecha_reserva"
                (change)="onChangeFechaReserva()"
              />
            </label>

            <label class="fecha-item">
              <span class="lbl">Check-out</span>
              <input
                type="date"
                [min]="minFechaCaducidad"
                [(ngModel)]="fecha_caducidad"
                name="fecha_caducidad"
                (change)="onChangeFechaCaducidad()"
              />
            </label>
          </div>

          <!-- Fechas del PAQUETE: resumen solo lectura, sin Angular Material -->
          <div class="fechas-grid fechas-paquete" *ngIf="esPaquete">
            <div class="fecha-item">
              <span class="lbl">Fechas del paquete</span>
              <div class="fecha-rango-readonly">
                <i-bs name="calendar3" width="16" height="16" class="icon"></i-bs>
                <span class="fecha-rango-text">
                  {{ formatFechaSimple(fecha_reserva) }} – {{ formatFechaSimple(fecha_caducidad) }}
                </span>
              </div>
              <p class="muted mini">({{ noches }} noches)</p>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="resumen-precio">
          <div class="line">
            {{ hotel.precio }} BOB × {{ noches }} noches
            <span class="right">{{ subtotal }} BOB</span>
          </div>
          <div class="line">
            IVA (13%)
            <span class="right">{{ iva }} BOB</span>
          </div>
        </div>

        <div class="resumen-total">
          <div class="total-row">
            <span>Total</span>
            <span class="price">{{ total }} BOB</span>
          </div>
          <p class="muted mini">Impuestos incluidos</p>
        </div>

        <ul class="beneficios">
          <li><i-bs name="check-circle" width="16" height="16" class="icon good"></i-bs> Confirmación inmediata</li>
          <li><i-bs name="headset" width="16" height="16" class="icon good"></i-bs> Atención al cliente 24/7</li>
        </ul>
      </aside>
    </div>

    <div class="modal-backdrop" *ngIf="showSuccessModal">
      <dialog class="modal-card success" open>
        <div class="icon-circle success">✔</div>
        <h2>¡Reserva Confirmada!</h2>
        <p>Tu reserva ha sido confirmada exitosamente.</p>
        <p class="reserva-id">Código: <strong>{{ successCodigo }}</strong></p>
        <button class="btn btn-primary" (click)="cerrarSuccess()">Ver detalle</button>
      </dialog>
    </div>

    <div class="modal-backdrop" *ngIf="showConflictModal" (click)="cerrarConflict()">
      <dialog class="modal-card conflict" open>
        <div class="icon-circle error">!</div>
        <h2>Fechas Ocupadas</h2>
        <p>La próxima fecha disponible es el <strong>{{ conflictNextAvailable | date:'longDate' }}</strong>.</p>
        <div class="btn-group">
          <button class="btn btn-secondary" (click)="cerrarConflict()">Cancelar</button>
          <button class="btn btn-primary" (click)="usarFechaSugerida()">Usar sugerencia</button>
        </div>
      </dialog>
    </div>

    <div class="toast error" [class.show]="showErrorToast">
      <i-bs name="x-circle" width="18" height="18" class="icon"></i-bs>
      {{ errorMessage }}
      <button class="close-btn" (click)="showErrorToast = false">
        <i-bs name="x" width="20" height="20" class="icon"></i-bs>
      </button>
    </div>
  </div>
</main>
