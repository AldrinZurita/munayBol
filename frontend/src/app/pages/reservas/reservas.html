<div class="reserva-container">
  <a class="back-link" routerLink="/habitacion-detalle">
    &larr; Volver a los detalles
  </a>
  <h1>Completar Reserva</h1>
  <div class="reserva-main">
    <section class="pago-card">
      <h3><span class="icon material-symbols-rounded">credit_card</span> Información de Pago</h3>
      <p class="pago-desc">Ingresa los datos de tu tarjeta de crédito o débito</p>
      <form>
        <label>
          Número de tarjeta
          <input type="text" maxlength="19" placeholder="1234 5678 9012 3456" [(ngModel)]="tarjeta" name="tarjeta" required (input)="onTarjetaInput($event)" />
        </label>
        <label>
          Nombre del titular
          <input type="text" placeholder="Nombre como aparece en la tarjeta" [(ngModel)]="nombre" name="nombre" required />
        </label>
        <div class="row">
          <label>
            Fecha de expiración
            <input type="text" maxlength="5" placeholder="MM/AA" [(ngModel)]="expiracion" name="expiracion" required (input)="onExpiracionInput($event)" />
          </label>
          <label>
            CVV
            <input type="text" maxlength="3" placeholder="123" [(ngModel)]="cvv" name="cvv" required />
          </label>
        </div>
        <div class="pago-seguro">
          <span class="icon material-symbols-rounded">shield_lock</span>
          <span>
            <b>Pago 100% seguro</b><br />
            Tus datos están protegidos con encriptación SSL
          </span>
        </div>
        <button class="btn btn--pago" type="button" (click)="confirmarPago()" [disabled]="creating || pagoInvalido()" [attr.aria-busy]="creating ? 'true' : 'false'">
          <span class="spinner" *ngIf="creating"></span>
          <span *ngIf="!creating">Confirmar Pago - {{ total }} BOB</span>
          <span *ngIf="creating">Procesando...</span>
        </button>
      </form>
    </section>
    <aside class="resumen-card">
      <h4>Resumen de reserva</h4>
      <div class="hotel-info">
        <b>{{ hotel.nombre }}</b>
        <div><span class="icon material-symbols-rounded">location_on</span> {{ hotel.ciudad }}</div>
      </div>
      <div class="resumen-datos">
        <div><span class="icon material-symbols-rounded">group</span> Huéspedes <span class="right">{{ huespedes }}</span></div>
        <div>Noches <span class="right">{{ noches }}</span></div>
        <div class="fechas-grid">
          <label class="fecha-item">
            <span class="lbl">Check-in</span>
            <input type="date" [min]="minFechaReserva" [(ngModel)]="fecha_reserva" name="fecha_reserva" (change)="onChangeFechaReserva()" />
          </label>
          <label class="fecha-item">
            <span class="lbl">Check-out</span>
            <input type="date" [min]="minFechaCaducidad" [(ngModel)]="fecha_caducidad" name="fecha_caducidad" (change)="onChangeFechaCaducidad()" />
          </label>
        </div>
      </div>
      <div class="resumen-precio">
        <div>{{ hotel.precio }} BOB x {{ noches }} noches <span class="right">{{ subtotal }} BOB</span></div>
        <div>IVA (13%) <span class="right">{{ iva }} BOB</span></div>
      </div>
      <div class="resumen-total">
        <b>Total <span class="orange">{{ total }} BOB</span></b>
      </div>
      <ul class="beneficios">
        <li>✓ Cancelación gratuita hasta 24 horas antes</li>
        <li>✓ Confirmación inmediata</li>
        <li>✓ Atención al cliente 24/7</li>
      </ul>
    </aside>
  </div>

  <!-- Modal Éxito -->
  <div class="modal-backdrop" *ngIf="showSuccessModal">
    <dialog class="modal-card" open aria-labelledby="reservaConfirmadaTitulo">
      <div class="icon-circle success">✔</div>
      <h2 id="reservaConfirmadaTitulo">¡Reserva Confirmada!</h2>
      <p>Tu reserva de habitación ha sido confirmada exitosamente. Recibirás un email con todos los detalles.</p>
      <p><b>Confirmación:</b> {{ successCodigo }}<br>
         <b>Total pagado:</b> {{ successTotal }} BOB</p>
      <button class="btn-modal" (click)="cerrarSuccess()">Volver al Inicio</button>
    </dialog>
  </div>

  <!-- Modal Conflicto -->
  <div class="modal-backdrop" *ngIf="showConflictModal">
    <dialog class="modal-card warning" open aria-labelledby="conflictoTitulo">
      <div class="icon-circle warn">!</div>
      <h2 id="conflictoTitulo">Fechas ocupadas</h2>
      <p>Otro usuario reservó ese rango mientras completabas el pago.</p>
      <p>Próxima fecha disponible: <b>{{ conflictNextAvailable }}</b></p>
      <div class="modal-actions">
        <button class="btn-sec" (click)="cerrarConflict()">Cerrar</button>
        <button class="btn-principal" (click)="usarFechaSugerida()">Usar fecha sugerida</button>
      </div>
    </dialog>
  </div>

  <!-- Toast Error -->
  <div class="toast-error" *ngIf="showErrorToast">{{ errorMessage }}</div>
</div>