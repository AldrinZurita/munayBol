<div class="perfil-root">
  <div class="bg fx fx-a" aria-hidden="true"></div>
  <div class="bg fx fx-b" aria-hidden="true"></div>
  <div class="sparkles" *ngIf="animateFun" aria-hidden="true"></div>

  <div class="perfil-container">
    <h1 class="title">
      <span class="title__icon material-symbols-outlined" aria-hidden="true">account_circle</span>
      Mi Perfil
      <span class="title__glow" aria-hidden="true"></span>
    </h1>

    <section *ngIf="usuario" class="perfil-card">

      <div class="perfil-header">
        <div class="avatar-wrapper">
          <img *ngIf="usuario.avatar_url; else avatarInicial"
               [src]="usuario.avatar_url"
               class="avatar-img"
               referrerpolicy="no-referrer"
               alt="avatar" />
          <ng-template #avatarInicial>
            <div class="avatar-placeholder">
              <span>{{ (usuario.nombre || usuario.correo).charAt(0).toUpperCase() }}</span>
            </div>
          </ng-template>
        </div>

        <div class="info-principal">
          <h2 class="nombre-usuario">
            {{ usuario.nombre }}
            <span class="badge role">{{ usuario.rol | titlecase }}</span>
          </h2>
          <p class="rol-usuario subtle">
            ID: {{ usuario.id || ($any(usuario)._id || '—') }}
          </p>
        </div>

        <div class="header-actions">
          <button class="chip"
                  type="button"
                  title="Estado de cuenta"
                  [class.nope]="!usuario.estado"
                  [attr.aria-pressed]="usuario.estado">
            <span class="dot" aria-hidden="true"></span>
            {{ usuario.estado ? 'Activo' : 'Inactivo' }}
          </button>
        </div>
      </div>

      <div class="perfil-body" *ngIf="!editando; else formEdicion">
        <div class="detalle-item">
          <span class="label">Correo Electrónico</span>
          <span class="valor">{{ usuario.correo }}</span>
        </div>
        <div class="detalle-item">
          <span class="label">País</span>
          <span class="valor">{{ usuario.pais || '—' }}</span>
        </div>
        <div class="detalle-item">
          <span class="label">Pasaporte</span>
          <span class="valor">{{ usuario.pasaporte || '—' }}</span>
        </div>
        <div *ngIf="usuario.fecha_creacion" class="detalle-item">
          <span class="label">Miembro Desde</span>
          <span class="valor">{{ usuario.fecha_creacion | date:'longDate' }}</span>
        </div>

        <div class="acciones">
          <button class="btn-primario" (click)="activarEdicion()">
            <span class="material-symbols-outlined" aria-hidden="true">edit</span>
            Editar perfil
          </button>
        </div>
      </div>

      <ng-template #formEdicion>
        <form class="perfil-form" (ngSubmit)="guardarCambios()" autocomplete="off">
          <div class="form-grid">
            <div class="campo">
              <label for="pf-nombre">Nombre</label>
              <input id="pf-nombre" [(ngModel)]="form.nombre" name="nombre" required />
            </div>
            <div class="campo">
              <label for="pf-pais">País</label>
              <input id="pf-pais" [(ngModel)]="form.pais" name="pais" />
            </div>
            <div class="campo">
              <label for="pf-pass">Pasaporte</label>
              <input id="pf-pass" [(ngModel)]="form.pasaporte" name="pasaporte" />
            </div>
            <div class="campo stretch">
              <label for="pf-avatar">Foto (URL)</label>
              <input id="pf-avatar" [(ngModel)]="form.avatar_url" name="avatar_url" placeholder="https://..." />
              <small class="ayuda">Si iniciaste con Google/GitHub, se usa su foto; aquí puedes pegar otra URL si quieres.</small>
            </div>

            <div class="preview" aria-hidden="true">
              <div class="preview__title">Previsualización</div>
              <div class="avatar-wrapper">
                <img *ngIf="form.avatar_url; else preAvatarInicial"
                     [src]="form.avatar_url!"
                     class="avatar-img"
                     (error)="onAvatarError($event)"
                     alt="preview"/>
                <ng-template #preAvatarInicial>
                  <div class="avatar-placeholder"><span>{{ (form.nombre || usuario.correo || '?').charAt(0).toUpperCase() }}</span></div>
                </ng-template>
              </div>
            </div>
          </div>

          <div class="acciones">
            <button type="submit" class="btn-primario" [disabled]="guardando">
              <span class="material-symbols-outlined" aria-hidden="true">save</span>
              Guardar
            </button>
            <button type="button" class="btn-secundario" (click)="cancelarEdicion()" [disabled]="guardando">
              <span class="material-symbols-outlined" aria-hidden="true">close</span>
              Cancelar
            </button>
          </div>
          <div class="mensaje-error estado error" *ngIf="errorGuardar">{{ errorGuardar }}</div>
        </form>
      </ng-template>
    </section>
    <section *ngIf="usuario" class="reservas-section">
      <div class="section-header">
        <h2>
          <span class="material-symbols-outlined" aria-hidden="true">luggage</span>
          Mis Reservas
        </h2>
        <button type="button" class="fx-toggle" (click)="triggerFun()" [class.active]="animateFun" title="Ver animación">
          <span class="material-symbols-outlined" aria-hidden="true">auto_awesome</span>
        </button>
      </div>
      <div *ngIf="errorReservas" class="estado error">
        {{ errorReservas }}
      </div>
      <div *ngIf="!errorReservas && reservas.length === 0" class="estado">
        <span class="material-symbols-outlined" aria-hidden="true">flight_takeoff</span>
        <p>No tienes reservas aún.</p>
        <a routerLink="/paquetes" class="btn-detalle" style="margin-top:8px">
          <span class="material-symbols-outlined" aria-hidden="true">map</span>
          Explorar Paquetes
        </a>
      </div>
      <div class="lista-reservas" *ngIf="!errorReservas && reservas.length > 0">
        <article
          *ngFor="let reserva of reservas; trackBy: trackByReserva"
          class="reserva-card"
          [class.is-cancelled]="!reserva.estado"
          [class.is-removing]="removing.has(reserva.id_reserva)">
          <div class="reserva-card__image-wrapper">
            <img *ngIf="reserva.lugar?.url_image_lugar_turistico || reserva.hotel?.url_imagen_hotel; else imgPlaceholder"
                 [src]="reserva.lugar?.url_image_lugar_turistico || reserva.hotel?.url_imagen_hotel"
                 [alt]="'Foto de ' + (reserva.lugar?.nombre || reserva.hotel?.nombre || 'destino')" />
            <ng-template #imgPlaceholder>
              <div class="placeholder">
                <span class="material-symbols-outlined" aria-hidden="true">
                  {{ reserva.id_paquete ? 'map' : 'hotel' }}
                </span>
              </div>
            </ng-template>
          </div>
          <div class="reserva-card__content">
            <div class="reserva-header">
              <span class="status-badge" [ngClass]="{ 'activa': reserva.estado, 'cancelada': !reserva.estado }">
                <span class="dot" aria-hidden="true"></span>
                {{ reserva.estado ? 'Activa' : 'Cancelada' }}
              </span>
              <p class="lugar">
                <span class="material-symbols-outlined" aria-hidden="true">
                  {{ reserva.id_paquete ? 'map' : 'location_on' }}
                </span>
                {{ reserva.lugar?.nombre || reserva.hotel?.departamento || 'Destino no especificado' }}
              </p>
              <h3 *ngIf="reserva.id_paquete && reserva.hotel" class="hotel-paquete">
                <span class="material-symbols-outlined" aria-hidden="true">hotel</span>
                {{ reserva.hotel.nombre }}
              </h3>
              <p class="fecha-reserva subtle">
                Reservado el {{ reserva.fecha_reserva | date:'longDate' }}
              </p>
            </div>
            <div class="reserva-body">
              <div class="detalle-item">
                <span class="label">Check-in</span>
                <span class="valor">{{ reserva.fecha_entrada | date:'fullDate' }}</span>
              </div>
              <div class="detalle-item">
                <span class="label">Check-out</span>
                <span class="valor">{{ reserva.fecha_salida | date:'fullDate' }}</span>
              </div>
              <div class="detalle-item">
                <span class="label">Huéspedes</span>
                <span class="valor">{{ reserva.numero_huespedes }}</span>
              </div>
              <div class="detalle-item" *ngIf="reserva.fecha_caducidad">
                <span class="label">Caducidad</span>
                <span class="valor">{{ reserva.fecha_caducidad | date:'fullDate' }}</span>
              </div>
              <div class="detalle-item" *ngIf="reserva.num_habitacion">
                <span class="label">Habitación</span>
                <span class="valor">{{ reserva.num_habitacion }}</span>
              </div>
            </div>
            <div class="reserva-footer">
              <button type="button" class="btn-detalle"
                      *ngIf="reserva.id_paquete"
                      [routerLink]="['/paquetes/detalle', reserva.id_paquete]">
                <span class="material-symbols-outlined" aria-hidden="true">explore</span>
                Ver Paquete
              </button>
              <button type="button" class="btn-detalle"
                      *ngIf="!reserva.id_paquete && reserva.hotel"
                      [routerLink]="['/hoteles/detalle', reserva.hotel.id_hotel]">
                <span class="material-symbols-outlined" aria-hidden="true">hotel</span>
                Ver Hotel
              </button>
              <div class="cancel-wrapper" *ngIf="reserva.estado">
                <button type="button" class="btn-cancel"
                        *ngIf="confirmId !== reserva.id_reserva"
                        (click)="toggleConfirm(reserva.id_reserva)"
                        [disabled]="cancelling.has(reserva.id_reserva)">
                  <span class="material-symbols-outlined" aria-hidden="true">event_busy</span>
                  Cancelar
                </button>
                <div class="confirm-box" *ngIf="confirmId === reserva.id_reserva">
                  <span class="confirm-label">¿Seguro?</span>
                  <button type="button" class="btn-danger" (click)="confirmarCancel(reserva)">
                    <span class="material-symbols-outlined" aria-hidden="true">delete</span>
                    Sí, anular
                  </button>
                  <button type="button" class="btn-link" (click)="closeConfirm()">No</button>
                </div>
              </div>

            </div>
          </div>
        </article>
      </div>
    </section>
  </div>
</div>
