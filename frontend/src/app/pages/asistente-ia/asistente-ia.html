<div class="asistente-root">
  <div class="bg fx fx-a" aria-hidden="true"></div>
  <div class="bg fx fx-b" aria-hidden="true"></div>

  <div class="asistente-container" role="application" aria-label="Asistente IA MunayBol">
    <header class="header">
      <div class="logo"><div class="spark">ü§ñ</div></div>

      <div class="title">
        <h1>Asistente IA MunayBol</h1>
        <p>Tu gu√≠a personal de turismo boliviano</p>
      </div>

      <div class="toolbar">
        <button class="icon-btn" (click)="exportarChat()" [disabled]="respuestas.length===0" title="Exportar conversaci√≥n" aria-label="Exportar conversaci√≥n">
          <span class="material-symbols-outlined" aria-hidden="true">download</span>
        </button>

        <button class="icon-btn" (click)="nuevoChat()" [disabled]="sending" title="Nueva conversaci√≥n" aria-label="Nueva conversaci√≥n">
          <span class="material-symbols-outlined" aria-hidden="true">add_comment</span>
        </button>

        <button class="icon-btn" (click)="sidebarOpen = !sidebarOpen" title="Mostrar/ocultar historial" aria-label="Mostrar/ocultar historial">
          <span class="material-symbols-outlined" aria-hidden="true">view_sidebar</span>
        </button>

        <div class="header-glow" aria-hidden="true"></div>
      </div>
    </header>

    <div class="layout">
      <!-- Sidebar: historial -->
      <aside class="sidebar" [class.closed]="!sidebarOpen" aria-label="Historial de conversaciones">
        <div class="sb-header">
          <div class="search">
            <input
              type="search"
              [(ngModel)]="search"
              (keyup.enter)="applyFilters()"
              placeholder="Buscar en tus conversaciones..." />
            <button class="icon-btn" (click)="applyFilters()" title="Buscar">
              <span class="material-symbols-outlined" aria-hidden="true">search</span>
            </button>
          </div>

          <label class="switch">
            <input type="checkbox" [(ngModel)]="showArchived" (change)="applyFilters()" />
            <span>Archivadas</span>
          </label>

          <button class="new-session" (click)="nuevoChat()" title="Nueva conversaci√≥n">
            <span class="material-symbols-outlined" aria-hidden="true">add</span>
            Nueva
          </button>
        </div>

        <div class="sb-body" [class.loading]="loadingSessions">
          <!-- Skeleton cards while loading -->
          <ng-container *ngIf="loadingSessions">
            <div class="group">
              <div class="group-title">Cargando...</div>
              <div class="session-skel" *ngFor="let k of [1,2,3,4,5,6]">
                <div class="skel-title"></div>
                <div class="skel-meta"></div>
              </div>
            </div>
          </ng-container>

          <!-- Saved chats groups -->
          <ng-container *ngIf="!loadingSessions">
            <div class="group" *ngFor="let g of groupedSessions()">
              <div class="group-title">{{ g.label }}</div>

              <button
                class="session-item"
                *ngFor="let s of g.items"
                [class.active]="s.id === currentSessionId"
                (click)="goToSession(s)">
                <div class="top">
                  <div class="title" [title]="s.title || 'Sin t√≠tulo'">
                    {{ s.title || 'Sin t√≠tulo' }}
                    <span class="chip" *ngIf="s.archived">Archivada</span>
                  </div>
                  <div class="meta">
                    <span class="time">{{ s.updated_at | date:'short' }}</span>
                    <span class="count" title="Mensajes">üí¨ {{ s.messages_count }}</span>
                  </div>
                </div>
                <div class="actions" (click)="$event.stopPropagation()">
                  <button class="icon-btn mini" [disabled]="renamingId===s.id" (click)="renameSession(s)" title="Renombrar">
                    <span class="material-symbols-outlined" aria-hidden="true">edit</span>
                  </button>
                  <button class="icon-btn mini" [disabled]="archivingId===s.id" (click)="toggleArchive(s)" [title]="s.archived ? 'Desarchivar' : 'Archivar'">
                    <span class="material-symbols-outlined" aria-hidden="true">{{ s.archived ? 'unarchive' : 'archive' }}</span>
                  </button>
                  <button class="icon-btn mini danger" [disabled]="deletingId===s.id" (click)="deleteSession(s)" title="Eliminar">
                    <span class="material-symbols-outlined" aria-hidden="true">delete</span>
                  </button>
                </div>
              </button>
            </div>

            <div class="empty" *ngIf="sessions.length === 0">
              <p>No tienes conversaciones a√∫n.</p>
              <button class="new-session" (click)="nuevoChat()">Crear la primera</button>
            </div>
          </ng-container>
        </div>
      </aside>

      <!-- Chat body -->
      <section class="chat" #chatScroll (scroll)="onChatScroll($event)" aria-live="polite" aria-label="Historial del chat">
        <!-- Load older messages -->
        <div class="load-more" *ngIf="hasMore && !loadingMessages">
          <button class="load-btn" (click)="loadMore()">
            <span class="material-symbols-outlined" aria-hidden="true">expand_less</span>
            Cargar mensajes anteriores
          </button>
        </div>
        <div class="load-more" *ngIf="loadingMessages">
          <div class="loader"></div>
        </div>

        <!-- Welcome -->
        <div class="message ia welcome" *ngIf="respuestas.length === 0 && !typing">
          <div class="bubble">
            <div class="bubble-head">
              <span class="msg-icon">ü§ñ</span>
              <span class="who">Asistente</span>
              <span class="spacer"></span>
            </div>
            <div class="content">
              <p>¬°Bienvenido a la IA de MunayBol! Cu√©ntame a qu√© departamento o lugar tur√≠stico de Bolivia quieres ir y te mostrar√© paquetes, lugares imperdibles y habitaciones disponibles.</p>
            </div>
          </div>
        </div>

        <!-- Messages -->
        <ng-container *ngFor="let r of respuestas; let i = index; trackBy: trackByMsg">
          <div class="day-separator" *ngIf="isNewDay(i)">
            <span>{{ r.t | date:'fullDate' }}</span>
          </div>

          <div class="message" [ngClass]="{'ia': r.from==='ia', 'user': r.from==='user', 'group-start': isGroupStart(i)}">
            <div class="bubble" [class.skeleton]="r.text === '' && r.from === 'ia'">
              <div class="bubble-head">
                <ng-container *ngIf="r.from === 'user'; else iaIcon">
                  <div class="user-avatar">
                    <img *ngIf="auth.getUser()?.avatar_url"
                         [src]="auth.getUser()!.avatar_url"
                         [alt]="auth.getUser()?.nombre"
                         class="avatar-img" />
                    <div *ngIf="!auth.getUser()?.avatar_url" class="avatar-initials">
                      {{ getUserInitials() }}
                    </div>
                  </div>
                </ng-container>
                <ng-template #iaIcon><span class="msg-icon">ü§ñ</span></ng-template>

                <span class="who">{{ r.from === 'ia' ? 'Asistente' : 'T√∫' }}</span>
                <span class="spacer"></span>
                <time class="when" [attr.datetime]="(r.t | date:'yyyy-MM-ddTHH:mm:ss')">{{ r.t | date:'shortTime' }}</time>
              </div>

              <div class="content">
                <ng-container *ngIf="r.from === 'ia'; else userPlain">
                  <div class="prose" [innerHTML]="renderMarkdown(r.text)"></div>
                </ng-container>
                <ng-template #userPlain>
                  <p class="prose">{{ r.text }}</p>
                </ng-template>
              </div>

              <div class="bubble-actions">
                <button class="copy" (click)="copiar(r.text)" title="Copiar mensaje" aria-label="Copiar mensaje">
                  <span class="material-symbols-outlined" aria-hidden="true">content_copy</span>
                </button>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Typing -->
        <div class="message ia typing" *ngIf="typing">
          <div class="bubble">
            <div class="bubble-head">
              <span class="msg-icon">ü§ñ</span>
              <span class="who">Asistente</span>
              <span class="spacer"></span>
            </div>
            <div class="typing-animated">
              <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </div>
          </div>
        </div>

        <!-- FAB -->
        <button class="fab-down" *ngIf="showScrollToBottom" (click)="scrollToBottom()" title="Ir al √∫ltimo mensaje" aria-label="Ir al √∫ltimo mensaje">
          <span class="material-symbols-outlined" aria-hidden="true">south</span>
        </button>
      </section>
    </div>

    <!-- Input area -->
    <footer class="input-container" aria-label="Ingresar mensaje">
      <button class="icon-btn reset" (click)="nuevoChat()" [disabled]="sending" title="Nueva conversaci√≥n" aria-label="Nueva conversaci√≥n">
        <span class="material-symbols-outlined" aria-hidden="true">delete_sweep</span>
      </button>

      <input
        type="text"
        [disabled]="sending"
        [(ngModel)]="prompt"
        (keyup.enter)="enviar()"
        [attr.aria-busy]="sending"
        [placeholder]="sending ? 'Enviando...' : 'Escribe tu consulta, e.g., Quiero ir a Cochabamba...'"
        autocomplete="off" />

      <button class="send" [class.waiting]="sending" (click)="enviar()" [disabled]="sending || !prompt.trim()" title="Enviar" aria-label="Enviar">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path fill="currentColor" d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
        </svg>
      </button>
    </footer>

    <p class="hint">
      Pregunta por destinos, paquetes tur√≠sticos, lugares para visitar o habitaciones disponibles en Bolivia.
    </p>

    <div class="quick-buttons" role="list" aria-label="Sugerencias r√°pidas">
      <button class="option" role="listitem" (click)="enviarQuick('Quiero viajar a La Paz')">
        <h3><strong>La Paz </strong></h3>
        <span>Ciudad maravillosa</span>
      </button>
      <button class="option" role="listitem" (click)="enviarQuick('Quiero conocer el Salar de Uyuni')">
        <h3><strong>Salar de Uyuni </strong></h3>
        <span>Espejo del cielo</span>
      </button>
      <button class="option" role="listitem" (click)="enviarQuick('¬øCu√°les son las ofertas de paquetes econ√≥micos?')">
        <h3><strong>Ofertas </strong></h3>
        <span>Paquetes econ√≥micos</span>
      </button>
    </div>
  </div>
</div>
