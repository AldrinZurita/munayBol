<div class="asistente-root">
  <div class="layout-grid">
    <header class="app-header" role="banner">
      <div class="brand-block">
        <div class="brand-icon" aria-hidden="true">ü§ñ</div>
        <div class="brand-text">
          <h1>MunayBol Asistente</h1>
          <p class="subtitle">Gu√≠a inteligente de turismo boliviano</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn ghost" (click)="exportarChat()" [disabled]="respuestas.length===0" aria-label="Exportar conversaci√≥n">
          <span class="material-symbols-outlined">download</span>
        </button>
        <button class="btn ghost" (click)="nuevoChat()" [disabled]="sending" aria-label="Nueva conversaci√≥n">
          <span class="material-symbols-outlined">add_comment</span>
        </button>
        <button class="btn ghost" (click)="toggleLayoutMode()" aria-label="Cambiar vista">
          <span class="material-symbols-outlined">{{ compactMode ? 'view_agenda' : 'view_list' }}</span>
        </button>
        <button class="btn ghost" (click)="sidebarOpen = !sidebarOpen" aria-expanded="{{sidebarOpen}}" aria-label="Mostrar/ocultar historial">
          <span class="material-symbols-outlined">{{ sidebarOpen ? 'close' : 'view_sidebar' }}</span>
        </button>
      </div>
    </header>

    <aside class="sidebar" [class.closed]="!sidebarOpen" role="complementary" aria-label="Historial">
      <div class="sidebar-header">
        <button class="btn primary full" (click)="nuevoChat()" [disabled]="sending">
          <span class="material-symbols-outlined">add</span>
          Nueva conversaci√≥n
        </button>
        <div class="search-box">
          <input type="search" [(ngModel)]="search" (keyup.enter)="applyFilters()" placeholder="Buscar..." aria-label="Buscar conversaciones" />
          <button class="btn icon" (click)="applyFilters()" aria-label="Buscar">
            <span class="material-symbols-outlined">search</span>
          </button>
        </div>
        <label class="archive-toggle">
          <input type="checkbox" [(ngModel)]="showArchived" (change)="applyFilters()" />
          <span>Mostrar archivadas</span>
        </label>
      </div>

      <div class="sessions-list custom-scroll">
        <ng-container *ngFor="let g of groupedSessions()">
          <div class="group">
            <div class="group-title">{{ g.label }}</div>
            <button class="session-card"
                    *ngFor="let s of g.items"
                    [class.active]="s.id === currentSessionId"
                    (click)="goToSession(s)">
              <div class="session-head">
                <h3>{{ s.title || 'Sin t√≠tulo' }}</h3>
                <span class="chip" *ngIf="s.archived">Archivada</span>
              </div>
              <div class="session-meta">
                <span>{{ s.updated_at | date:'short' }}</span>
                <span>üí¨ {{ s.messages_count }}</span>
              </div>
              <div class="session-preview" *ngIf="s.preview_query">
                <span class="q-label">Consulta:</span>
                <span class="q-text" [title]="s.preview_query">{{ s.preview_query }}</span>
              </div>
              <div class="session-actions" (click)="$event.stopPropagation()">
                <button class="btn icon sm" [disabled]="renamingId===s.id" (click)="renameSession(s)" aria-label="Renombrar">
                  <span class="material-symbols-outlined">edit</span>
                </button>
                <button class="btn icon sm" [disabled]="archivingId===s.id" (click)="toggleArchive(s)" aria-label="Archivar/desarchivar">
                  <span class="material-symbols-outlined">{{ s.archived ? 'unarchive' : 'archive' }}</span>
                </button>
                <button class="btn icon sm danger" [disabled]="deletingId===s.id" (click)="deleteSession(s)" aria-label="Eliminar">
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </button>
          </div>
        </ng-container>
        <div class="empty" *ngIf="sessions.length === 0">
          <p>No hay conversaciones a√∫n.</p>
          <button class="btn primary" (click)="nuevoChat()">
            <span class="material-symbols-outlined">add_circle</span>
            Crear conversaci√≥n
          </button>
        </div>
      </div>
    </aside>

    <main class="chat-panel custom-scroll" #chatScroll (scroll)="onChatScroll($event)" role="main" aria-live="polite" aria-label="Conversaci√≥n">
      <div class="query-header" *ngIf="lastUserQuery() as q">
        <div class="query-chip">Consulta</div>
        <div class="query-text" [title]="q">{{ q }}</div>
      </div>

      <div class="load-more" *ngIf="hasMore && !loadingMessages">
        <button class="btn outline" (click)="loadMore()">
          <span class="material-symbols-outlined">expand_less</span>
          Cargar anteriores ({{ totalMessages - respuestas.length }})
        </button>
      </div>
      <div class="loading-inline" *ngIf="loadingMessages">
        <div class="spinner"></div><span>Cargando...</span>
      </div>

      <div class="welcome" *ngIf="respuestas.length === 0 && !typing && !currentSession?.messages_count">
        <div class="welcome-card">
          <h2>Bienvenido üëã</h2>
          <p>Indica un departamento o atractivo y te mostrar√© informaci√≥n oficial, hoteles y consejos. Ejemplos:</p>
          <ul>
            <li>Quiero viajar a La Paz</li>
            <li>Necesito informaci√≥n de Potos√≠</li>
            <li>Recomi√©ndame lugares en Tarija</li>
          </ul>
        </div>
      </div>

      <ng-container *ngFor="let r of respuestas; let i = index; trackBy: trackByMsg">
        <div class="day-separator" *ngIf="isNewDay(i)">
          <span>{{ r.t | date:'fullDate' }}</span>
        </div>

        <article class="message" [class.ia]="r.from==='ia'" [class.user]="r.from==='user'" [class.group-start]="isGroupStart(i)">
          <div class="avatar ia" *ngIf="r.from==='ia'">ü§ñ</div>
          <div class="avatar user" *ngIf="r.from==='user'">
            <img *ngIf="auth.getUser()?.avatar_url" [src]="auth.getUser()!.avatar_url" [alt]="auth.getUser()?.nombre" />
            <span *ngIf="!auth.getUser()?.avatar_url">{{ getUserInitials() }}</span>
          </div>
          <div class="bubble">
            <header class="bubble-head">
              <span class="who">{{ r.from==='ia' ? 'Asistente' : 'T√∫' }}</span>
              <time class="when">{{ r.t | date:'shortTime' }}</time>
              <div class="bubble-actions">
                <button class="btn icon sm ghost" (click)="copiar(r.text)" aria-label="Copiar">
                  <span class="material-symbols-outlined">content_copy</span>
                </button>
              </div>
            </header>

            <div class="bubble-content">
              <ng-container *ngIf="r.from==='ia'; else plainUser">
                <ng-container *ngIf="structuredSections(r.text).length > 0; else rawHtml">
                  <div class="sections-wrapper">
                    <div class="sections-controls sticky">
                      <button class="btn tiny" (click)="expandAll()">
                        <span class="material-symbols-outlined">unfold_more</span> Expandir todo
                      </button>
                      <button class="btn tiny" (click)="collapseAll()">
                        <span class="material-symbols-outlined">unfold_less</span> Colapsar todo
                      </button>
                      <button class="btn tiny" (click)="toggleCompact()">
                        <span class="material-symbols-outlined">{{ compactMode ? 'view_comfy_alt' : 'view_compact' }}</span>
                        Vista {{ compactMode ? 'detallada' : 'compacta' }}
                      </button>
                    </div>
                    <div class="section-grid" [class.compact]="compactMode">
                      <div class="section-card"
                           *ngFor="let sec of structuredSections(r.text)"
                           [class.collapsed]="collapsedSections.has(sec.id)">
                        <header (click)="toggleSection(sec.id)" [attr.aria-expanded]="!collapsedSections.has(sec.id)">
                          <h3>{{ sec.title }}</h3>
                          <span class="toggle-indicator">
                            <span class="material-symbols-outlined">
                              {{ collapsedSections.has(sec.id) ? 'expand_more' : 'expand_less' }}
                            </span>
                          </span>
                        </header>
                        <div class="section-body" *ngIf="!collapsedSections.has(sec.id)">
                          <ng-container [ngSwitch]="sec.type">
                            <ul *ngSwitchCase="'list'">
                              <li *ngFor="let it of sec.items">
                                <strong *ngIf="it.nombre">{{ it.nombre }}</strong><span *ngIf="it.descripcion">: {{ it.descripcion }}</span>
                                <div class="submeta" *ngIf="it.horario || it.costos">
                                  <span *ngIf="it.horario">Horario: {{ it.horario }}</span>
                                  <span *ngIf="it.costos">
                                    <ng-container *ngFor="let kv of objectEntries(it.costos); let last = last">
                                      {{ kv.key }}: {{ kv.value }}<span *ngIf="!last"> | </span>
                                    </ng-container>
                                  </span>
                                </div>
                              </li>
                            </ul>
                            <ul *ngSwitchCase="'hoteles'">
                              <li *ngFor="let h of sec.items">
                                <strong>{{ h.nombre }}</strong> ‚Äî {{ h.ubicacion }}
                                <div class="submeta">
                                  Calificaci√≥n: {{ h.calificacion }}/5
                                  <span *ngIf="h.rango_precios_bs"> | Precios: {{ h.rango_precios_bs }}</span>
                                </div>
                              </li>
                            </ul>
                            <ul *ngSwitchCase="'gastronomia'">
                              <li class="principal"><strong>Plato tradicional:</strong> {{ sec.plato_tradicional }}</li>
                              <li *ngFor="let g of sec.extras">
                                {{ g.nombre }} ‚Äî Bs. {{ g.costo_aprox_bs }}
                              </li>
                            </ul>
                            <div *ngSwitchCase="'texto'" class="text-block">
                              <p *ngFor="let p of sec.paragraphs">{{ p }}</p>
                              <ul *ngIf="sec.list && sec.list.length">
                                <li *ngFor="let f of sec.list">{{ f }}</li>
                              </ul>
                            </div>
                            <div *ngSwitchDefault class="text-block">
                              <p>No hay datos para esta secci√≥n.</p>
                            </div>
                          </ng-container>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>
                <ng-template #rawHtml>
                  <div class="prose" [innerHTML]="renderMarkdown(r.text)"></div>
                </ng-template>
              </ng-container>
              <ng-template #plainUser>
                <p class="user-text">{{ r.text }}</p>
              </ng-template>
            </div>
          </div>
        </article>
      </ng-container>

      <div class="typing-indicator" *ngIf="typing">
        <div class="dots"><span></span><span></span><span></span></div>
      </div>

      <button class="scroll-bottom-btn"
              *ngIf="showScrollToBottom"
              (click)="scrollToBottom()"
              aria-label="Ir al √∫ltimo mensaje">
        <span class="material-symbols-outlined">south</span>
      </button>
    </main>

    <footer class="composer" aria-label="Enviar mensaje">
      <div class="composer-inner">
        <button class="btn ghost" (click)="nuevoChat()" [disabled]="sending" aria-label="Nueva conversaci√≥n">
          <span class="material-symbols-outlined">refresh</span>
        </button>
        <input
          type="text"
          [(ngModel)]="prompt"
          [disabled]="sending"
          (keyup.enter)="enviar()"
          [placeholder]="sending ? 'Enviando...' : 'Escribe tu consulta (Ej: Itinerario 3 d√≠as en La Paz)'"
          autocomplete="off"
          aria-label="Mensaje" />
        <button class="btn send" (click)="enviar()" [disabled]="sending || !prompt.trim()" aria-label="Enviar">
          <span class="material-symbols-outlined">send</span>
        </button>
      </div>
      <div class="quick-suggestions">
        <button class="suggestion" (click)="enviarQuick('Itinerario 3 d√≠as en La Paz')">Itinerario La Paz</button>
        <button class="suggestion" (click)="enviarQuick('Recomi√©ndame lugares en Tarija')">Tarija</button>
        <button class="suggestion" (click)="enviarQuick('Mejor √©poca para visitar Santa Cruz')">Santa Cruz</button>
        <button class="suggestion" (click)="enviarQuick('Hoteles recomendados en Cochabamba')">Hoteles Cbba</button>
      </div>
    </footer>
  </div>
</div>
