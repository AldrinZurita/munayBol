<main class="hoteles-page">
  <div class="hoteles-container">
    <header class="header">
      <h1 class="title">
        <span class="title-icon">
          <span class="fi fi-bo" role="img" aria-label="Bandera de Bolivia" title="Bolivia"></span>
        </span>
        Hoteles en Bolivia
      </h1>

      <button *ngIf="isSuperAdmin" class="btn btn-add icon-only" (click)="openAddHotelModal()" title="Agregar Hotel"
        aria-label="Agregar Hotel">
        <i-bs name="plus-square-fill" width="22" height="22" class="icon-center"></i-bs>
      </button>
    </header>

    <section class="filtros-card card">
      <h2 class="card-title">Filtros de búsqueda</h2>
      <div class="filtros-grid">
        <div class="filtro filtro-busqueda">
          <label for="busqueda" class="form-label">Buscar (nombre o ubicación)</label>
          <div class="search-wrapper">
            <i-bs name="search" width="18" height="18" class="search-icon icon-center icon-secondary"
              aria-hidden="true"></i-bs>
            <input id="busqueda" type="search" class="form-input" placeholder="Ej.: Marriott, Centro…"
              [(ngModel)]="searchTerm" (ngModelChange)="aplicarFiltros()" aria-label="Buscar hoteles" />
            <button type="button" class="btn btn-secondary-soft icon-only clear-btn" *ngIf="searchTerm"
              (click)="searchTerm=''; aplicarFiltros()" title="Limpiar búsqueda" aria-label="Limpiar búsqueda">
              <i-bs name="funnel" width="18" height="18" class="icon-center"></i-bs>
            </button>
          </div>
        </div>

        <div class="filtro filtro-depto">
          <label for="ciudad" class="form-label">Departamento</label>
          <div class="select-wrapper">
            <select id="ciudad" class="form-select" [(ngModel)]="ciudadSeleccionada" (change)="aplicarFiltros()"
              aria-label="Filtrar por departamento">
              <option value="">Todos los departamentos</option>
              <option *ngFor="let ciudad of ciudades" [value]="ciudad">
                {{ ciudad }}
              </option>
            </select>
            <i-bs class="chevron-icon icon-center icon-secondary" name="chevron-down" width="16" height="16"
              aria-hidden="true"></i-bs>
          </div>
        </div>

        <div class="filtro filtro-calif">
          <label for="calificacion" class="form-label">Calificación</label>
          <div class="select-wrapper">
            <select id="calificacion" class="form-select" [(ngModel)]="calificacionSeleccionada"
              (change)="aplicarFiltros()" aria-label="Filtrar por calificación">
              <option value="">Todas</option>
              <option *ngFor="let cal of [10,9,8,7,6,5,4,3,2,1,0]" [value]="cal">{{ cal }}</option>
            </select>
            <i-bs class="chevron-icon icon-center icon-secondary" name="chevron-down" width="16" height="16"
              aria-hidden="true"></i-bs>
          </div>
        </div>

        <div class="acciones">
          <button class="btn btn-accent icon-only" (click)="aplicarFiltros()" title="Aplicar filtros"
            aria-label="Aplicar filtros">
            <i-bs name="funnel" width="18" height="18" class="icon-center"></i-bs>
          </button>
          <button class="btn btn-secondary-soft icon-only" (click)="clearFilters()" title="Limpiar filtros"
            aria-label="Limpiar filtros">
            <i-bs name="x-circle" width="18" height="18" class="icon-center"></i-bs>
          </button>
        </div>

        <div class="resultados" aria-live="polite">
          Resultados: <strong>{{ hotelesFiltrados.length }}</strong>
        </div>
      </div>
    </section>

    <section class="estado" role="status" aria-live="polite">
      <div *ngIf="error" class="error">{{ error }}</div>

      <div *ngIf="hotelesFiltrados.length === 0 && !error" class="no-result">
        <span class="material-symbols-outlined icon-center icon-secondary" aria-hidden="true">info</span>
        No hay hoteles que coincidan con el filtro.
      </div>
    </section>

    <section class="lista">
      <article *ngFor="let hotel of hotelesFiltrados; trackBy: trackByHotel" class="card reveal">
        <div class="card-left">
          <h3 class="hotel-nombre">{{ hotel.nombre }}</h3>

          
            <div class="imagen-hotel"
     *ngIf="hotel.url_imagen_hotel"
     [style.backgroundImage]="'url(' + hotel.url_imagen_hotel + ')'"
     role="img"
     aria-label="Imagen de {{ hotel.nombre }}">
</div>


          <br>
          <div class="facts" style="text-decoration: none;">
            <span class="fact">
              <i-bs name="geo-alt" width="16" height="16" class="icon-center"></i-bs>
              <span class="fact-text"> {{ hotel.departamento || '—' }}</span>
            </span>
            <br>
            <span class="fact">
              <i-bs name="building" width="16" height="16" class="icon-center"></i-bs>
              <span class="fact-text"> Hotel <span class="estado-pill" [class.inactivo]="hotel.estado===false">{{
                  hotel.estado === false ? 'Inactivo' : 'Activo' }}</span></span>
            </span>
          </div>
          <br>
          <div class="rating-row" *ngIf="hotel.calificacion !== undefined && hotel.calificacion !== null">
            <span class="stars">
              <ng-container *ngFor="let s of getStarIcons(hotel.calificacion)">
                <i-bs [name]="s === 'full' ? 'star-fill' : (s === 'half' ? 'star-half' : 'star')" width="16" height="16"
                  class="icon-center icon-star"></i-bs>
              </ng-container>
            </span>
            <!-- <span class="rating-text">{{ formatFiveScale(hotel.calificacion) }}</span> -->
          </div>

          <p class="descripcion" style="margin-left: 2rem;" *ngIf="hotel.ubicacion">{{ hotel.ubicacion }}</p>

          <div class="fecha-admin" *ngIf="isSuperAdmin && hotel.fecha_creacion">
            <span class="label">Fecha de creación:</span> {{ hotel.fecha_creacion | date:'longDate' }}
          </div>
        </div>

        <div class="card-actions-centered">
          <button class="btn btn-ghost icon-only hotel-manage" (click)="onVerDetalles(hotel.id_hotel)"
            title="Ver Detalles" aria-label="Ver Detalles">
            <i-bs name="eye" width="18" height="18" class="icon-center"></i-bs>
          </button>

          <ng-container *ngIf="isSuperAdmin">
            <button class="icon-btn btn-edit hotel-manage" (click)="openEditHotelModal(hotel)" title="Editar"
              aria-label="Editar">
              <i-bs name="pencil" width="18" height="18" class="icon-center"></i-bs>
            </button>
            <button class="icon-btn btn-delete hotel-manage" (click)="onEliminarHotel(hotel)" title="Eliminar"
              aria-label="Eliminar">
              <i-bs name="trash" width="18" height="18" class="icon-center"></i-bs>
            </button>
          </ng-container>
        </div>
      </article>
    </section>
  </div>

  <div class="modal-backdrop" *ngIf="showModal" (click)="closeHotelModal()" aria-hidden="true"></div>
  <div class="modal-root" *ngIf="showModal" role="dialog" aria-modal="true" aria-labelledby="modalTitleHotel"
    (click)="closeHotelModal()">
    <div class="modal-ornaments" aria-hidden="true">
      <span class="orbit orbit-1"></span>
      <span class="orbit orbit-2"></span>
      <span class="glow glow-1"></span>
      <span class="glow glow-2"></span>
    </div>

    <div class="modal-card animate-in" (click)="$event.stopPropagation()"
      [attr.aria-busy]="savingModal ? 'true' : 'false'">
      <header class="modal-header">
        <h3 id="modalTitleHotel">
          {{ isEditMode ? 'Editar Hotel' : 'Agregar Nuevo Hotel' }}
        </h3>
        <button class="icon-btn" (click)="closeHotelModal()" aria-label="Cerrar">
          <span class="material-symbols-outlined icon-center icon-secondary">close</span>
        </button>
      </header>

      <form #hotelForm="ngForm" (ngSubmit)="isEditMode ? saveEditHotel(hotelForm) : saveNewHotel(hotelForm)" novalidate class="editModal-form">
        <div class="modal-body" aria-describedby="modalScrollHelpHotel">
          <div id="modalScrollHelpHotel" class="sr-only">Desplázate dentro de este área para ver todo el contenido del
            formulario.</div>

          <div class="form-grid">
            <div class="field">
              <label class="form-label" for="h-nombre">Nombre *</label>
              <input id="h-nombre" name="nombre" type="text" class="form-input" [(ngModel)]="modalHotelModel.nombre"
                required />
            </div>

            <div class="field">
              <label class="form-label" for="h-departamento">Departamento *</label>
              <input id="h-departamento" name="departamento" type="text" class="form-input"
                [(ngModel)]="modalHotelModel.departamento" required />
            </div>

            <div class="field">
              <label class="form-label" for="h-ubicacion">Ubicación *</label>
              <input id="h-ubicacion" name="ubicacion" type="text" class="form-input"
                [(ngModel)]="modalHotelModel.ubicacion" required />
            </div>

            <div class="field">
              <label class="form-label" for="h-calificacion">Calificación (0-10)</label>
              <input id="h-calificacion" name="calificacion" type="number" min="0" max="10" step="0.1"
                class="form-input" [(ngModel)]="modalHotelModel.calificacion" />
            </div>

            <div class="field">
              <label class="form-label" for="h-estado">Estado</label>
              <select id="h-estado" name="estado" class="form-select" [(ngModel)]="modalHotelModel.estado">
                <option [ngValue]="true">Activo</option>
                <option [ngValue]="false">Inactivo</option>
              </select>
            </div>

            <div class="field span-2">
              <label class="form-label" for="h-url" style="width: 60%;">URL de imagen</label>
              <input id="h-url" name="url_imagen_hotel" type="text" class="form-input"
                [(ngModel)]="modalHotelModel.url_imagen_hotel" />
            </div>

            <div class="field span-2">
              <label class="form-label">Previsualización</label>
              <div class="img-preview-wrapper">
                <img [src]="modalHotelModel.url_imagen_hotel || 'assets/no-image.svg'" alt="Previsualización"
                  (error)="onModalImageError($event)" />
              </div>
            </div>
          </div>
        </div>

        <footer class="modal-footer">
          <div class="loader-inline" *ngIf="savingModal">
            <span class="spinner"></span> Guardando...
          </div>
          <button type="button" class="btn btn-secondary" (click)="closeHotelModal()" [disabled]="savingModal">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!hotelForm.valid || savingModal">
            Guardar
          </button>
        </footer>
      </form>
    </div>
  </div>
  <!-- Backdrop del modal de eliminación -->
<div class="modal-backdrop" *ngIf="showDeleteModal" aria-hidden="true" (click)="cancelarEliminacionHotel()"></div>

<!-- Modal de confirmación de eliminación -->
<div class="modal-root confirm-delete" *ngIf="showDeleteModal" role="dialog" aria-modal="true" (click)="cancelarEliminacionHotel()">
  <div class="modal-card animate-in" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h3>¿Eliminar hotel '{{ hotelAEliminar?.nombre }}'?</h3>
      <button class="icon-btn" (click)="cancelarEliminacionHotel()" aria-label="Cerrar">
        <span class="material-symbols-outlined icon-center icon-secondary">close</span>
      </button>
    </header>

    <div class="modal-body">
      <p>Para confirmar la eliminación, escribe <strong>ELIMINAR</strong> en el campo siguiente:</p>
      <input
        type="text"
        class="form-input"
        [(ngModel)]="confirmacionTexto"
        placeholder="Escribe 'ELIMINAR'"
        aria-label="Confirmar eliminación"
      />
      <div class="error" *ngIf="errorEliminar && !mensajeEliminacion">
        Texto incorrecto. Escribe exactamente 'ELIMINAR'.
      </div>
    </div>

    <footer class="modal-footer modal-footer-delete">
      <div class="status-area">
        <div class="loading-dots" *ngIf="eliminandoHotel">Eliminando<span>.</span><span>.</span><span>.</span></div>
        <div class="success-message" *ngIf="mensajeEliminacion">{{ mensajeEliminacion }}</div>
        <div class="error" *ngIf="errorEliminar && !mensajeEliminacion">Texto incorrecto. Escribe exactamente 'ELIMINAR'.</div>
      </div>

      <div class="footer-actions">
        

        <button
          class="icon-btn btn-delete"
          [disabled]="confirmacionTexto !== 'ELIMINAR' || eliminandoHotel"
          (click)="confirmarEliminacionHotel()"
          aria-label="Eliminar"
          title="Eliminar hotel"
        >
          <i-bs name="trash" width="18" height="18" class="icon-center"></i-bs>
        </button>
      </div>
    </footer>
  </div>
</div>

</main>