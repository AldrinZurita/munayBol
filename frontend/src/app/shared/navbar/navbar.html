<nav
  class="navbar"
  role="navigation"
  aria-label="Navegación principal"
  [class.scrolled]="scrolled"
  [class.at-top]="atTop"
  [class.hidden]="hidden"
  [class.mounted]="mounted"
  [class.shrink]="shrink"
  [class.route-home]="routeHome"
  [class.internal]="!routeHome"
  [class.contrast-light]="headerContrast === 'light'"
  [class.contrast-dark]="headerContrast === 'dark'"
>
  <div class="navbar__route" *ngIf="routeLoading" aria-hidden="true"></div>
  <div class="navbar__progress" [style.width.%]="scrollProgress" aria-hidden="true"></div>

  <div class="navbar__container">
    <h1 class="logo ani-stagger">
      <a routerLink="/" aria-label="Ir a inicio" (click)="onNavItemSelect($event)">
        <span class="logo__munay">Munay Bol</span>
      </a>
    </h1>

    <button
      class="hamburger ani-stagger"
      type="button"
      aria-label="Abrir menú"
      aria-controls="primary-menu"
      [attr.aria-expanded]="mobileOpen"
      (click)="toggleMobile(); onControlSelect($event)"
    >
      <span class="hamburger__bar"></span>
      <span class="hamburger__bar"></span>
      <span class="hamburger__bar"></span>
    </button>

    <ul
      #navList
      id="primary-menu"
      class="nav-list"
      [class.open]="mobileOpen"
      (mouseleave)="clearInk()"
      role="menubar"
    >
      <div class="nav-ink" [class.visible]="inkVisible" [style.transform]="inkTransform" [style.width.px]="inkW" aria-hidden="true"></div>

      <li class="nav-item ani-stagger" role="none">
        <a role="menuitem" routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
           (mouseenter)="onNavItemEnter($event)" (focus)="onNavItemEnter($event)"
           (click)="onNavItemSelect($event); onNavLinkClick()">
          <span class="nav-text">Inicio</span>
        </a>
      </li>

      <li class="nav-item ani-stagger" role="none">
        <a role="menuitem" routerLink="/lugares-turisticos" routerLinkActive="active"
           (mouseenter)="onNavItemEnter($event)" (focus)="onNavItemEnter($event)"
           (click)="onNavItemSelect($event); onNavLinkClick()">
          <span class="nav-text">Lugares Turísticos</span>
        </a>
      </li>

      <li class="nav-item ani-stagger" role="none">
        <a role="menuitem" routerLink="/paquetes" routerLinkActive="active"
           (mouseenter)="onNavItemEnter($event)" (focus)="onNavItemEnter($event)"
           (click)="onNavItemSelect($event); onNavLinkClick()">
          <span class="nav-text">Paquetes</span>
        </a>
      </li>

      <li class="nav-item ani-stagger" role="none">
        <a role="menuitem" routerLink="/hoteles" routerLinkActive="active"
           (mouseenter)="onNavItemEnter($event)" (focus)="onNavItemEnter($event)"
           (click)="onNavItemSelect($event); onNavLinkClick()">
          <span class="nav-text">Hoteles</span>
        </a>
      </li>
    </ul>

    <div class="session-actions ani-stagger">
      <button class="icon-btn search-btn" type="button" aria-label="Buscar o ir rápidamente (Ctrl/Cmd + K)"
              (click)="openPalette(); onControlSelect($event)">
        <span class="material-symbols-outlined">search</span>
      </button>

      <ng-container *ngIf="isLoggedIn; else showLogin">
        <div class="user-actions">
          <app-notification class="notif-ani" (click)="onControlSelect($event)"></app-notification>

          <!-- --- NUEVO: Botón para cambiar el tema --- -->
          <button 
            class="icon-btn theme-toggle" 
            type="button" 
            [attr.aria-label]="(theme$ | async) === 'dark' ? 'Activar modo claro' : 'Activar modo oscuro'"
            (click)="toggleTheme(); onControlSelect($event)">
            <span *ngIf="(theme$ | async) === 'dark'" class="material-symbols-outlined">light_mode</span>
            <span *ngIf="(theme$ | async) === 'light'" class="material-symbols-outlined">dark_mode</span>
          </button>
          <!-- --- Fin del nuevo botón --- -->

          <div class="user-menu" [class.open]="userMenuOpen">
            <button class="user-menu-trigger" type="button" aria-haspopup="menu"
                    [attr.aria-expanded]="userMenuOpen" (click)="toggleUserMenu($event); onControlSelect($event)">
              <ng-container *ngIf="user?.avatar_url; else initials">
                <img [src]="user?.avatar_url" class="avatar" referrerpolicy="no-referrer" alt="avatar" />
              </ng-container>
              <ng-template #initials>
                <div class="avatar initials" aria-hidden="true">{{ (username || '?')[0] | uppercase }}</div>
              </ng-template>

              <span class="username">{{ username }}</span>
              <span class="material-symbols-outlined chevron" aria-hidden="true">expand_more</span>
            </button>

            <div class="user-menu-content" role="menu">
              <a *ngIf="isSuperAdmin"
                 routerLink="/admin/reservas"
                 class="user-menu-item"
                 role="menuitem"
                 (click)="onNavItemSelect($event); closeMenus()">
                <span class="material-symbols-outlined" aria-hidden="true">admin_panel_settings</span>
                Gestión de Reservas
              </a>

              <a *ngIf="isSuperAdmin"
                 routerLink="/admin/usuarios"
                 class="user-menu-item"
                 role="menuitem"
                 (click)="onNavItemSelect($event); closeMenus()">
                <span class="material-symbols-outlined" aria-hidden="true">manage_accounts</span>
                Gestión de Usuarios
              </a>

              <a routerLink="/perfil" class="user-menu-item" role="menuitem" (click)="onNavItemSelect($event); closeMenus()">
                <span class="material-symbols-outlined" aria-hidden="true">account_circle</span>
                Mi Perfil
              </a>
              <button class="user-menu-item" role="menuitem" (click)="onControlSelect($event); logout(); closeMenus()">
                <span class="material-symbols-outlined" aria-hidden="true">logout</span>
                Cerrar Sesión
              </button>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #showLogin>
        <button class="btn cta-login" routerLink="/login" (click)="onControlSelect($event)">Iniciar Sesión</button>
      </ng-template>
    </div>
  </div>

  <div class="palette" *ngIf="paletteOpen" role="dialog" aria-modal="true" aria-label="Buscar y ejecutar acciones" (click)="closePalette()">
    <div class="palette__panel" (click)="$event.stopPropagation()">
      <div class="palette__header">
        <span class="material-symbols-outlined" aria-hidden="true">search</span>
        <input
          type="text"
          class="palette__input"
          [value]="paletteQuery"
          (input)="onPaletteInput($any($event.target).value)"
          placeholder="Buscar... (Ctrl/Cmd + K)"
          autofocus
        />
        <button class="palette__close" type="button" aria-label="Cerrar" (click)="closePalette()">
          <span class="material-symbols-outlined" aria-hidden="true">close</span>
        </button>
      </div>

      <ul class="palette__list">
        <li class="palette__item" *ngFor="let it of filteredPalette; let i = index" (click)="go(it)" tabindex="0">
          <span class="material-symbols-outlined palette__icon" aria-hidden="true">{{ it.icon }}</span>
          <span class="palette__label">{{ it.label }}</span>
          <span class="material-symbols-outlined palette__chev" aria-hidden="true">chevron_right</span>
        </li>
        <li class="palette__empty" *ngIf="filteredPalette.length === 0">Sin resultados</li>
      </ul>

      <div class="palette__footer">
        <span class="kbd">Esc</span> cerrar • <span class="kbd">Ctrl/Cmd + K</span> abrir
      </div>
    </div>
  </div>
</nav>