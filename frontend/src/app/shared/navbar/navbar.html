<nav
  class="navbar"
  role="navigation"
  aria-label="Navegación principal"
  [class.scrolled]="scrolled"
  [class.at-top]="atTop"
  [class.hidden]="hidden"
  [class.mounted]="mounted"
  [class.shrink]="shrink"
  [class.route-home]="routeHome"
  [class.internal]="!routeHome"
  [class.contrast-light]="headerContrast === 'light'"
  [class.contrast-dark]="headerContrast === 'dark'"
>
  <div class="navbar__route" *ngIf="routeLoading" aria-hidden="true"></div>
  <div class="navbar__progress" [style.width.%]="scrollProgress" aria-hidden="true"></div>

  <div class="navbar__container">
    <h1 class="logo ani-stagger">
       <div class="title_logo">
        <span class="ff-brand__emblem" aria-hidden="true">
          <svg width="26" height="26" viewBox="0 0 48 48" focusable="false">
            <defs>
              <linearGradient id="ffFlagGrad" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#d32f2f"/>
                <stop offset="50%" stop-color="#facc15"/>
                <stop offset="100%" stop-color="#16a34a"/>
              </linearGradient>
            </defs>
            <circle cx="24" cy="24" r="18" fill="url(#ffFlagGrad)" opacity="0.95"/>
          </svg>
        </span>
      <a routerLink="/" aria-label="Ir a inicio" (click)="onNavItemSelect($event)">
        <span class="logo__munay">MunayBol</span>
      </a>
       </div>
    </h1>

    <button
      class="hamburger ani-stagger"
      type="button"
      aria-label="Abrir menú"
      aria-controls="primary-menu"
      [attr.aria-expanded]="mobileOpen"
      (click)="toggleMobile(); onControlSelect($event)"
    >
      <span class="hamburger__bar"></span>
      <span class="hamburger__bar"></span>
      <span class="hamburger__bar"></span>
    </button>

    <ul
      #navList
      id="primary-menu"
      class="nav-list"
      [class.open]="mobileOpen"
      (mouseleave)="clearInk()"
      role="menubar"
    >
      <div class="nav-ink" [class.visible]="inkVisible" [style.transform]="inkTransform" [style.width.px]="inkW" aria-hidden="true"></div>

      <li class="nav-item ani-stagger" role="none">
        <a role="menuitem" routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
           (mouseenter)="onNavItemEnter($event)" (focus)="onNavItemEnter($event)"
           (click)="onNavItemSelect($event); onNavLinkClick()">
          <span class="nav-text">Inicio</span>
        </a>
      </li>

      <li class="nav-item ani-stagger" role="none">
        <a role="menuitem" routerLink="/lugares-turisticos" routerLinkActive="active"
           (mouseenter)="onNavItemEnter($event)" (focus)="onNavItemEnter($event)"
           (click)="onNavItemSelect($event); onNavLinkClick()">
          <span class="nav-text">Lugares Turísticos</span>
        </a>
      </li>

      <li class="nav-item ani-stagger" role="none">
        <a role="menuitem" routerLink="/paquetes" routerLinkActive="active"
           (mouseenter)="onNavItemEnter($event)" (focus)="onNavItemEnter($event)"
           (click)="onNavItemSelect($event); onNavLinkClick()">
          <span class="nav-text">Paquetes</span>
        </a>
      </li>

      <li class="nav-item ani-stagger" role="none">
        <a role="menuitem" routerLink="/hoteles" routerLinkActive="active"
           (mouseenter)="onNavItemEnter($event)" (focus)="onNavItemEnter($event)"
           (click)="onNavItemSelect($event); onNavLinkClick()">
          <span class="nav-text">Hoteles</span>
        </a>
      </li>
    </ul>

    <div class="session-actions ani-stagger">


      <ng-container *ngIf="isLoggedIn; else showLogin">
        <div class="user-actions">
          <app-notification class="notif-ani" (click)="onControlSelect($event)"></app-notification>

          <!-- --- NUEVO: Botón para cambiar el tema --- -->
          <button 
            class="icon-btn theme-toggle" 
            type="button" 
            [attr.aria-label]="(theme$ | async) === 'dark' ? 'Activar modo claro' : 'Activar modo oscuro'"
            (click)="toggleTheme(); onControlSelect($event)">
            <span *ngIf="(theme$ | async) === 'dark'" class="material-symbols-outlined">light_mode</span>
            <span *ngIf="(theme$ | async) === 'light'" class="material-symbols-outlined">dark_mode</span>
          </button>
          <!-- --- Fin del nuevo botón --- -->

          <div class="user-menu" [class.open]="userMenuOpen">
            <button class="user-menu-trigger" type="button" aria-haspopup="menu"
                    [attr.aria-expanded]="userMenuOpen" (click)="toggleUserMenu($event); onControlSelect($event)">
              <ng-container *ngIf="user?.avatar_url; else initials">
                <img [src]="user?.avatar_url" class="avatar" referrerpolicy="no-referrer" alt="avatar" />
              </ng-container>
              <ng-template #initials>
                <div class="avatar initials" aria-hidden="true">{{ (username || '?')[0] | uppercase }}</div>
              </ng-template>

              <span class="username">{{ username }}</span>
              <span class="material-symbols-outlined chevron" aria-hidden="true">expand_more</span>
            </button>

            <div class="user-menu-content" role="menu">
              <a *ngIf="isSuperAdmin"
                 routerLink="/admin/reservas"
                 class="user-menu-item"
                 role="menuitem"
                 (click)="onNavItemSelect($event); closeMenus()">
                <span class="material-symbols-outlined" aria-hidden="true">admin_panel_settings</span>
                Gestión de Reservas
              </a>

              <a *ngIf="isSuperAdmin"
                 routerLink="/admin/usuarios"
                 class="user-menu-item"
                 role="menuitem"
                 (click)="onNavItemSelect($event); closeMenus()">
                <span class="material-symbols-outlined" aria-hidden="true">manage_accounts</span>
                Gestión de Usuarios
              </a>

              <a routerLink="/perfil" class="user-menu-item" role="menuitem" (click)="onNavItemSelect($event); closeMenus()">
                <span class="material-symbols-outlined" aria-hidden="true">account_circle</span>
                Mi Perfil
              </a>
              <button class="user-menu-item" role="menuitem" (click)="onControlSelect($event); logout(); closeMenus()">
                <span class="material-symbols-outlined" aria-hidden="true">logout</span>
                Cerrar Sesión
              </button>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #showLogin>
        <button class="btn cta-login" routerLink="/login" (click)="onControlSelect($event)">Iniciar Sesión</button>
      </ng-template>
    </div>
  </div>

</nav>